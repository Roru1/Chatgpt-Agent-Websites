<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text‑to‑Speech Downloader</title>

    <!-- Tailwind (demo‑only; ignore CDN warning) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- meSpeak v1.9.6 (browser‑ready build) -->
    <script src="https://cdn.jsdelivr.net/npm/mespeak@1.9.6/mespeak.min.js"></script>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <main class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-xl space-y-4">
      <h1 class="text-3xl font-bold text-center">Text‑to‑Speech Downloader</h1>

      <!-- Text input -->
      <textarea
        id="text"
        class="w-full border rounded p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
        rows="5"
        placeholder="Type or paste text here…"
      ></textarea>

      <!-- Filename input -->
      <input
        id="filename"
        type="text"
        class="w-full border rounded p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="File name (without extension), e.g. greeting"
      />

      <!-- Generate button -->
      <button
        id="generate"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-2xl transition ease-in-out duration-150 disabled:opacity-50"
        disabled
      >
        Generate &amp; Download
      </button>

      <!-- Status message -->
      <p id="status" class="text-sm text-gray-600 text-center"></p>
    </main>

    <script>
      // Run after both HTML and meSpeak have loaded
      window.addEventListener('load', init);

      async function init() {
        const statusEl = document.getElementById('status');
        const textEl   = document.getElementById('text');
        const fileEl   = document.getElementById('filename');
        const btnEl    = document.getElementById('generate');

        /* ----------------------------------------------------------
         * 1. Load config from an **embedded** object — avoids CORS.
         * 2. Fetch the English voice JSON with fetch() (CORS‑enabled).
         * --------------------------------------------------------*/
        try {
          statusEl.textContent = 'Loading voice…';

          const configObj = {
            // Tell meSpeak where voices live (we’ll fetch manually anyway)
            voices: 'voices/',
            audio: {
              encoding : 'wav',
              bits     : 16,
              rate     : 22050,
              channels : 1,
              volume   : 1,
            },
            speed : 175,
            pitch : 50,
          };
          meSpeak.loadConfig(configObj);

          // Fetch voice JSON ourselves so we control CORS
          const voiceUrl = 'https://cdn.jsdelivr.net/npm/mespeak@1.9.6/voices/en/en.json';
          const voiceJson = await fetch(voiceUrl).then(r => r.json());
          meSpeak.loadVoice(voiceJson);

          statusEl.textContent = 'Ready! Type some text and click Generate.';
          btnEl.disabled = false;

          btnEl.addEventListener('click', () => {
            const text = textEl.value.trim();
            if (!text) {
              alert('Please enter some text first.');
              return;
            }

            const filename = (fileEl.value.trim() || 'tts') + '.wav';
            statusEl.textContent = 'Generating speech…';

            meSpeak.speak(
              text,
              { rawdata: 'data-url' },
              (success, _id, wavDataUrl) => {
                if (!success) {
                  statusEl.textContent = '⚠️ Failed to generate speech.';
                  return;
                }

                const link = document.createElement('a');
                link.href = wavDataUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                statusEl.textContent = 'Download started!';
              }
            );
          });
        } catch (err) {
          console.error('TTS init error:', err);
          statusEl.textContent = '⚠️ Could not load voice data (CORS or network error).';
        }
      }
    </script>
  </body>
</html>
