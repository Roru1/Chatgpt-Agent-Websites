<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text‑to‑Speech Downloader</title>

    <!-- Tailwind (demo‑only; switch to a build pipeline for production) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- meSpeak v1.9.6 (the last version that ships a browser‑ready build) -->
    <script
      src="https://cdn.jsdelivr.net/npm/mespeak@1.9.6/mespeak.min.js"
      defer
    ></script>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <main class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-xl space-y-4">
      <h1 class="text-3xl font-bold text-center">Text‑to‑Speech Downloader</h1>

      <!-- Text input -->
      <textarea
        id="text"
        class="w-full border rounded p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
        rows="5"
        placeholder="Type or paste text here…"
      ></textarea>

      <!-- Filename input -->
      <input
        id="filename"
        type="text"
        class="w-full border rounded p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="File name (without extension), e.g. greeting"
      />

      <!-- Generate button -->
      <button
        id="generate"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-2xl transition ease-in-out duration-150 disabled:opacity-50"
        disabled
      >
        Generate &amp; Download
      </button>

      <!-- Status message -->
      <p id="status" class="text-sm text-gray-600 text-center"></p>
    </main>

    <script>
      // Wait until the DOM *and* meSpeak.js have both finished loading.
      window.addEventListener('DOMContentLoaded', async () => {
        await waitForMeSpeak();
        initTTS();
      });

      function waitForMeSpeak() {
        return new Promise((resolve, reject) => {
          // If the global appeared quickly, resolve immediately.
          if (window.meSpeak) return resolve();

          // Otherwise poll for up to 5 s.
          const start = Date.now();
          const id = setInterval(() => {
            if (window.meSpeak) {
              clearInterval(id);
              resolve();
            } else if (Date.now() - start > 5000) {
              clearInterval(id);
              reject(new Error('meSpeak failed to load'));
            }
          }, 50);
        });
      }

      async function initTTS() {
        const statusEl = document.getElementById('status');
        const textEl   = document.getElementById('text');
        const fileEl   = document.getElementById('filename');
        const btnEl    = document.getElementById('generate');

        try {
          statusEl.textContent = 'Loading voice…';

          // Load built‑in config from CDN
          await meSpeak.loadConfig('https://cdn.jsdelivr.net/npm/mespeak@1.9.6/mespeak_config.json');
          // Load English voice (or switch to another locale file)
          await meSpeak.loadVoice('https://cdn.jsdelivr.net/npm/mespeak@1.9.6/voices/en/en.json');

          statusEl.textContent = 'Ready! Type some text and click Generate.';
          btnEl.disabled = false;

          btnEl.addEventListener('click', () => {
            const text = textEl.value.trim();
            if (!text) {
              alert('Please enter some text first.');
              return;
            }

            const filename = (fileEl.value.trim() || 'tts') + '.wav';
            statusEl.textContent = 'Generating speech…';

            meSpeak.speak(text, { rawdata: 'data-url' }, (success, _id, wavDataUrl) => {
              if (!success) {
                statusEl.textContent = '⚠️ Failed to generate speech.';
                return;
              }

              const link = document.createElement('a');
              link.href = wavDataUrl;
              link.download = filename;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);

              statusEl.textContent = 'Download started!';
            });
          });
        } catch (e) {
          console.error(e);
          statusEl.textContent = '⚠️ Could not load meSpeak resources.';
        }
      }
    </script>
  </body>
</html>
